<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Search Logs - SaaS Monitoring</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    <style>
        .search-box {
            border-radius: 30px;
            padding: 12px 20px;
            font-size: 1.1rem;
        }
        
        .badge-level {
            min-width: 80px;
            padding: 6px 12px;
        }
        
        .status-2xx { color: #198754; font-weight: 600; }
        .status-4xx { color: #fd7e14; font-weight: 600; }
        .status-5xx { color: #dc3545; font-weight: 600; }
        
        .response-fast { color: #198754; }
        .response-medium { color: #ffc107; }
        .response-slow { color: #dc3545; }
        
        .sortable {
            cursor: pointer;
            user-select: none;
        }
        
        .sortable:hover {
            background-color: #f8f9fa;
        }
        
        .sort-icon {
            font-size: 0.8rem;
            margin-left: 5px;
            opacity: 0.5;
        }
        
        .sort-icon.active {
            opacity: 1;
        }
        
        .table-responsive {
            position: relative;
        }
        
        .loading-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.9);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        
        .loading-overlay.show {
            display: flex;
        }
        
        .truncate {
            max-width: 300px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        .initial-state {
            text-align: center;
            padding: 4rem 2rem;
            color: #6c757d;
        }
        
        .initial-state i {
            font-size: 5rem;
            margin-bottom: 1rem;
            opacity: 0.3;
        }
        
        .pagination {
            margin-top: 1rem;
        }
        
        .advanced-filters {
            display: none;
        }
        
        .advanced-filters.show {
            display: block;
        }
    </style>
</head>
<body>
    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container-fluid">
            <a class="navbar-brand" href="/">
                <i class="bi bi-graph-up-arrow me-2"></i>
                SaaS Log Monitoring
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="/">
                            <i class="bi bi-speedometer2 me-1"></i>Dashboard
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/upload">
                            <i class="bi bi-cloud-upload me-1"></i>Upload
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="/search">
                            <i class="bi bi-search me-1"></i>Search
                        </a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="container-fluid py-4">
        <div class="row mb-4">
            <div class="col-12">
                <h2 class="mb-3">
                    <i class="bi bi-search me-2 text-primary"></i>
                    Search Logs
                </h2>
            </div>
        </div>

        <!-- Search Section -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-body">
                        <!-- Main Search Input -->
                        <div class="input-group input-group-lg mb-3">
                            <span class="input-group-text bg-white">
                                <i class="bi bi-search"></i>
                            </span>
                            <input type="text" 
                                   class="form-control search-box border-start-0" 
                                   id="searchQuery" 
                                   placeholder="Search in messages, endpoints, user agents..."
                                   onkeypress="if(event.key === 'Enter') performSearch()">
                        </div>

                        <!-- Toggle Advanced Filters Button -->
                        <div class="mb-3">
                            <button class="btn btn-outline-secondary btn-sm" 
                                    type="button" 
                                    onclick="toggleAdvancedFilters()">
                                <i class="bi bi-funnel me-1"></i>
                                <span id="filterToggleText">Show Advanced Filters</span>
                            </button>
                        </div>

                        <!-- Advanced Filters -->
                        <div class="advanced-filters" id="advancedFilters">
                            <div class="row g-3 mb-3">
                                <!-- Log Level -->
                                <div class="col-md-3">
                                    <label class="form-label">Log Level</label>
                                    <select class="form-select" id="filterLevel">
                                        <option value="">ALL</option>
                                        <option value="DEBUG">DEBUG</option>
                                        <option value="INFO">INFO</option>
                                        <option value="WARNING">WARNING</option>
                                        <option value="ERROR">ERROR</option>
                                        <option value="CRITICAL">CRITICAL</option>
                                    </select>
                                </div>

                                <!-- Date From -->
                                <div class="col-md-3">
                                    <label class="form-label">Date From</label>
                                    <input type="datetime-local" class="form-control" id="filterDateFrom">
                                </div>

                                <!-- Date To -->
                                <div class="col-md-3">
                                    <label class="form-label">Date To</label>
                                    <input type="datetime-local" class="form-control" id="filterDateTo">
                                </div>

                                <!-- Status Code -->
                                <div class="col-md-3">
                                    <label class="form-label">Status Code</label>
                                    <select class="form-select" id="filterStatus">
                                        <option value="">ALL</option>
                                        <option value="2xx">2xx (Success)</option>
                                        <option value="4xx">4xx (Client Error)</option>
                                        <option value="5xx">5xx (Server Error)</option>
                                        <option value="200">200 (OK)</option>
                                        <option value="404">404 (Not Found)</option>
                                        <option value="500">500 (Internal Error)</option>
                                    </select>
                                </div>

                                <!-- Endpoint -->
                                <div class="col-md-4">
                                    <label class="form-label">Endpoint</label>
                                    <select class="form-select" id="filterEndpoint">
                                        <option value="">ALL</option>
                                    </select>
                                </div>

                                <!-- Server -->
                                <div class="col-md-4">
                                    <label class="form-label">Server</label>
                                    <select class="form-select" id="filterServer">
                                        <option value="">ALL</option>
                                        <option value="server-01">server-01</option>
                                        <option value="server-02">server-02</option>
                                        <option value="server-03">server-03</option>
                                        <option value="server-04">server-04</option>
                                        <option value="server-05">server-05</option>
                                    </select>
                                </div>

                                <!-- Results Per Page -->
                                <div class="col-md-4">
                                    <label class="form-label">Results Per Page</label>
                                    <select class="form-select" id="filterPerPage">
                                        <option value="25">25</option>
                                        <option value="50" selected>50</option>
                                        <option value="100">100</option>
                                        <option value="200">200</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <!-- Action Buttons -->
                        <div class="d-flex gap-2">
                            <button class="btn btn-primary" onclick="performSearch()">
                                <i class="bi bi-search me-1"></i>Search
                            </button>
                            <button class="btn btn-outline-secondary" onclick="resetSearch()">
                                <i class="bi bi-arrow-clockwise me-1"></i>Reset
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Results Section -->
        <div class="row" id="resultsSection" style="display: none;">
            <div class="col-12">
                <div class="card">
                    <div class="card-header bg-white d-flex justify-content-between align-items-center">
                        <div>
                            <h5 class="mb-0">Search Results</h5>
                            <small class="text-muted" id="resultsInfo"></small>
                        </div>
                        <button class="btn btn-success btn-sm" onclick="exportToCSV()" id="exportBtn" disabled>
                            <i class="bi bi-download me-1"></i>Export to CSV
                        </button>
                    </div>
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <!-- Loading Overlay -->
                            <div class="loading-overlay" id="loadingOverlay">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="visually-hidden">Loading...</span>
                                </div>
                            </div>

                            <!-- Results Table -->
                            <table class="table table-hover mb-0" id="resultsTable">
                                <thead class="table-light">
                                    <tr>
                                        <th class="sortable" onclick="sortBy('timestamp')">
                                            Timestamp
                                            <i class="bi bi-chevron-down sort-icon" id="sort-timestamp"></i>
                                        </th>
                                        <th class="sortable" onclick="sortBy('level')">
                                            Level
                                            <i class="bi bi-chevron-down sort-icon" id="sort-level"></i>
                                        </th>
                                        <th class="sortable" onclick="sortBy('endpoint')">
                                            Endpoint
                                            <i class="bi bi-chevron-down sort-icon" id="sort-endpoint"></i>
                                        </th>
                                        <th class="sortable" onclick="sortBy('status_code')">
                                            Status
                                            <i class="bi bi-chevron-down sort-icon" id="sort-status_code"></i>
                                        </th>
                                        <th class="sortable" onclick="sortBy('response_time_ms')">
                                            Response Time
                                            <i class="bi bi-chevron-down sort-icon" id="sort-response_time_ms"></i>
                                        </th>
                                        <th>Message</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="resultsBody">
                                    <!-- Initial State -->
                                    <tr id="initialState">
                                        <td colspan="7" class="initial-state">
                                            <i class="bi bi-search"></i>
                                            <h4>Start Your Search</h4>
                                            <p>Use the search box and filters above to find logs</p>
                                        </td>
                                    </tr>
                                    
                                    <!-- Empty State (hidden by default) -->
                                    <tr id="emptyState" style="display: none;">
                                        <td colspan="7" class="initial-state">
                                            <i class="bi bi-inbox"></i>
                                            <h4>No Results Found</h4>
                                            <p>Try adjusting your search criteria</p>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>

                        <!-- Pagination -->
                        <nav aria-label="Search results pagination" class="p-3" id="paginationContainer" style="display: none;">
                            <ul class="pagination justify-content-center mb-0" id="pagination"></ul>
                        </nav>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Log Details Modal -->
    <div class="modal fade" id="logDetailsModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="bi bi-file-text me-2"></i>Log Details
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="logDetailsContent">
                    <!-- Will be populated dynamically -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Custom JavaScript -->
    <script>
        // State management
        let currentPage = 1;
        let currentSort = { field: 'timestamp', order: 'desc' };
        let searchResults = null;

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            loadEndpoints();
            updateSortIcon('timestamp', 'desc');
        });

        // Toggle advanced filters
        function toggleAdvancedFilters() {
            const filters = document.getElementById('advancedFilters');
            const toggleText = document.getElementById('filterToggleText');
            
            if (filters.classList.contains('show')) {
                filters.classList.remove('show');
                toggleText.textContent = 'Show Advanced Filters';
            } else {
                filters.classList.add('show');
                toggleText.textContent = 'Hide Advanced Filters';
            }
        }

        // Load endpoints for filter dropdown
        async function loadEndpoints() {
            try {
                const response = await fetch('/api/search/endpoints');
                const data = await response.json();
                
                if (data.success && data.endpoints) {
                    const select = document.getElementById('filterEndpoint');
                    data.endpoints.forEach(endpoint => {
                        const option = document.createElement('option');
                        option.value = endpoint;
                        option.textContent = endpoint;
                        select.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('Error loading endpoints:', error);
            }
        }

        // Perform search
        async function performSearch(page = 1) {
            currentPage = page;
            
            // Build search parameters
            const params = {
                q: document.getElementById('searchQuery').value.trim(),
                level: document.getElementById('filterLevel').value,
                date_from: document.getElementById('filterDateFrom').value,
                date_to: document.getElementById('filterDateTo').value,
                endpoint: document.getElementById('filterEndpoint').value,
                status_code: document.getElementById('filterStatus').value,
                server: document.getElementById('filterServer').value,
                page: page,
                per_page: parseInt(document.getElementById('filterPerPage').value),
                sort_field: currentSort.field,
                sort_order: currentSort.order
            };

            // Show loading overlay
            document.getElementById('loadingOverlay').classList.add('show');
            document.getElementById('resultsSection').style.display = 'block';
            document.getElementById('initialState').style.display = 'none';
            document.getElementById('emptyState').style.display = 'none';

            try {
                const response = await fetch('/api/search', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(params)
                });

                const data = await response.json();

                if (data.success) {
                    searchResults = data;
                    renderResults(data);
                    renderPagination(data);
                    updateResultsInfo(data);
                    document.getElementById('exportBtn').disabled = false;
                } else {
                    throw new Error(data.error || 'Search failed');
                }
            } catch (error) {
                console.error('Search error:', error);
                alert('Search failed: ' + error.message);
            } finally {
                document.getElementById('loadingOverlay').classList.remove('show');
            }
        }

        // Render results
        function renderResults(data) {
            const tbody = document.getElementById('resultsBody');
            
            if (!data.results || data.results.length === 0) {
                tbody.innerHTML = '';
                document.getElementById('emptyState').style.display = '';
                document.getElementById('paginationContainer').style.display = 'none';
                return;
            }

            tbody.innerHTML = '';
            
            data.results.forEach(log => {
                const row = document.createElement('tr');
                
                // Timestamp
                const timestamp = new Date(log.timestamp);
                const formattedTime = timestamp.toLocaleDateString('en-US', { 
                    month: 'short', 
                    day: 'numeric', 
                    hour: '2-digit', 
                    minute: '2-digit' 
                });

                // Level badge
                let levelClass = 'secondary';
                if (log.level === 'ERROR' || log.level === 'CRITICAL') levelClass = 'danger';
                else if (log.level === 'WARNING') levelClass = 'warning';
                else if (log.level === 'INFO') levelClass = 'info';
                else if (log.level === 'DEBUG') levelClass = 'secondary';

                // Status class
                let statusClass = '';
                if (log.status_code >= 200 && log.status_code < 300) statusClass = 'status-2xx';
                else if (log.status_code >= 400 && log.status_code < 500) statusClass = 'status-4xx';
                else if (log.status_code >= 500) statusClass = 'status-5xx';

                // Response time class
                let responseClass = 'response-fast';
                if (log.response_time_ms > 1000) responseClass = 'response-slow';
                else if (log.response_time_ms > 500) responseClass = 'response-medium';

                // Truncate message
                const message = log.message || '-';
                const truncatedMessage = message.length > 100 ? message.substring(0, 100) + '...' : message;

                row.innerHTML = `
                    <td>${formattedTime}</td>
                    <td>
                        <span class="badge bg-${levelClass} badge-level">${log.level}</span>
                    </td>
                    <td><code>${log.endpoint || '-'}</code></td>
                    <td><span class="${statusClass}">${log.status_code || '-'}</span></td>
                    <td><span class="${responseClass}">${log.response_time_ms || 0} ms</span></td>
                    <td>
                        <span class="truncate" title="${message}">${truncatedMessage}</span>
                    </td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary" onclick="viewDetails('${log._id}')">
                            <i class="bi bi-eye"></i>
                        </button>
                    </td>
                `;
                
                tbody.appendChild(row);
            });
        }

        // Render pagination
        function renderPagination(data) {
            const container = document.getElementById('pagination');
            const paginationContainer = document.getElementById('paginationContainer');
            
            if (data.pages <= 1) {
                paginationContainer.style.display = 'none';
                return;
            }

            paginationContainer.style.display = 'block';
            container.innerHTML = '';

            // Previous button
            const prevLi = document.createElement('li');
            prevLi.className = `page-item ${data.page <= 1 ? 'disabled' : ''}`;
            prevLi.innerHTML = `<a class="page-link" href="#" onclick="changePage(${data.page - 1}); return false;">Previous</a>`;
            container.appendChild(prevLi);

            // Page numbers (max 10 visible)
            const startPage = Math.max(1, data.page - 5);
            const endPage = Math.min(data.pages, startPage + 9);

            for (let i = startPage; i <= endPage; i++) {
                const li = document.createElement('li');
                li.className = `page-item ${i === data.page ? 'active' : ''}`;
                li.innerHTML = `<a class="page-link" href="#" onclick="changePage(${i}); return false;">${i}</a>`;
                container.appendChild(li);
            }

            // Next button
            const nextLi = document.createElement('li');
            nextLi.className = `page-item ${data.page >= data.pages ? 'disabled' : ''}`;
            nextLi.innerHTML = `<a class="page-link" href="#" onclick="changePage(${data.page + 1}); return false;">Next</a>`;
            container.appendChild(nextLi);
        }

        // Change page
        function changePage(page) {
            window.scrollTo({ top: 0, behavior: 'smooth' });
            performSearch(page);
        }

        // Update results info
        function updateResultsInfo(data) {
            const start = (data.page - 1) * data.per_page + 1;
            const end = Math.min(data.page * data.per_page, data.total);
            document.getElementById('resultsInfo').textContent = 
                `Showing ${start}-${end} of ${data.total.toLocaleString()} results`;
        }

        // Sort by field
        function sortBy(field) {
            if (currentSort.field === field) {
                // Toggle order
                currentSort.order = currentSort.order === 'asc' ? 'desc' : 'asc';
            } else {
                // New field, default to descending
                currentSort.field = field;
                currentSort.order = 'desc';
            }

            updateSortIcon(field, currentSort.order);
            performSearch(currentPage);
        }

        // Update sort icon
        function updateSortIcon(field, order) {
            // Remove active class from all icons
            document.querySelectorAll('.sort-icon').forEach(icon => {
                icon.classList.remove('active', 'bi-chevron-up', 'bi-chevron-down');
                icon.classList.add('bi-chevron-down');
            });

            // Set active icon
            const icon = document.getElementById(`sort-${field}`);
            if (icon) {
                icon.classList.add('active');
                icon.classList.remove('bi-chevron-down', 'bi-chevron-up');
                icon.classList.add(order === 'asc' ? 'bi-chevron-up' : 'bi-chevron-down');
            }
        }

        // View details
        function viewDetails(logId) {
            const log = searchResults.results.find(l => l._id === logId);
            if (!log) return;

            const timestamp = new Date(log.timestamp).toLocaleString();
            let levelClass = 'secondary';
            if (log.level === 'ERROR' || log.level === 'CRITICAL') levelClass = 'danger';
            else if (log.level === 'WARNING') levelClass = 'warning';
            else if (log.level === 'INFO') levelClass = 'info';

            const content = `
                <div class="row g-3">
                    <div class="col-md-6">
                        <strong>Timestamp:</strong><br>
                        ${timestamp}
                    </div>
                    <div class="col-md-6">
                        <strong>Level:</strong><br>
                        <span class="badge bg-${levelClass}">${log.level}</span>
                    </div>
                    <div class="col-md-6">
                        <strong>Endpoint:</strong><br>
                        <code>${log.endpoint || '-'}</code>
                    </div>
                    <div class="col-md-6">
                        <strong>Method:</strong><br>
                        ${log.method || '-'}
                    </div>
                    <div class="col-md-6">
                        <strong>Status Code:</strong><br>
                        ${log.status_code || '-'}
                    </div>
                    <div class="col-md-6">
                        <strong>Response Time:</strong><br>
                        ${log.response_time_ms || 0} ms
                    </div>
                    <div class="col-md-6">
                        <strong>Client IP:</strong><br>
                        ${log.client_ip || '-'}
                    </div>
                    <div class="col-md-6">
                        <strong>User ID:</strong><br>
                        ${log.user_id || 'Anonymous'}
                    </div>
                    <div class="col-md-6">
                        <strong>Server:</strong><br>
                        ${log.server || '-'}
                    </div>
                    <div class="col-md-6">
                        <strong>Tenant ID:</strong><br>
                        ${log.tenant_id || '-'}
                    </div>
                    <div class="col-12">
                        <strong>Message:</strong><br>
                        <p class="mb-0">${log.message || '-'}</p>
                    </div>
                    <div class="col-12">
                        <strong>User Agent:</strong><br>
                        <small class="text-muted">${log.user_agent || '-'}</small>
                    </div>
                    ${log.sql_query ? `
                        <div class="col-12">
                            <strong>SQL Query:</strong><br>
                            <code class="d-block p-2 bg-light">${log.sql_query}</code>
                            <small class="text-muted">Duration: ${log.query_duration_ms || 0} ms</small>
                        </div>
                    ` : ''}
                </div>
            `;

            document.getElementById('logDetailsContent').innerHTML = content;
            const modal = new bootstrap.Modal(document.getElementById('logDetailsModal'));
            modal.show();
        }

        // Export to CSV
        function exportToCSV() {
            if (!searchResults || !searchResults.results || searchResults.results.length === 0) {
                alert('No results to export');
                return;
            }

            const headers = ['Timestamp', 'Level', 'Endpoint', 'Method', 'Status Code', 'Response Time (ms)', 'Client IP', 'User ID', 'Server', 'Tenant ID', 'Message', 'User Agent'];
            const rows = searchResults.results.map(log => [
                log.timestamp,
                log.level,
                log.endpoint || '',
                log.method || '',
                log.status_code || '',
                log.response_time_ms || '',
                log.client_ip || '',
                log.user_id || '',
                log.server || '',
                log.tenant_id || '',
                `"${(log.message || '').replace(/"/g, '""')}"`,
                `"${(log.user_agent || '').replace(/"/g, '""')}"`
            ]);

            let csv = headers.join(',') + '\n';
            rows.forEach(row => {
                csv += row.join(',') + '\n';
            });

            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `logs_export_${new Date().toISOString().split('T')[0]}.csv`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
        }

        // Reset search
        function resetSearch() {
            document.getElementById('searchQuery').value = '';
            document.getElementById('filterLevel').value = '';
            document.getElementById('filterDateFrom').value = '';
            document.getElementById('filterDateTo').value = '';
            document.getElementById('filterEndpoint').value = '';
            document.getElementById('filterStatus').value = '';
            document.getElementById('filterServer').value = '';
            document.getElementById('filterPerPage').value = '50';
            
            currentPage = 1;
            currentSort = { field: 'timestamp', order: 'desc' };
            searchResults = null;
            
            document.getElementById('resultsSection').style.display = 'none';
            document.getElementById('resultsBody').innerHTML = `
                <tr id="initialState">
                    <td colspan="7" class="initial-state">
                        <i class="bi bi-search"></i>
                        <h4>Start Your Search</h4>
                        <p>Use the search box and filters above to find logs</p>
                    </td>
                </tr>
            `;
            document.getElementById('exportBtn').disabled = true;
            
            updateSortIcon('timestamp', 'desc');
        }
    </script>
</body>
</html>
