input {
  file {
    path => "/data/uploads/*.csv"
    start_position => "beginning"
    sincedb_path => "/dev/null"
    codec => plain
    type => "csv"
  }
  
  file {
    path => "/data/uploads/*.json"
    start_position => "beginning"
    sincedb_path => "/dev/null"
    codec => json
    type => "json"
  }
}

filter {
  if [type] == "csv" {
    # Skip header line
    if [message] =~ /^timestamp,log_type/ {
      drop { }
    }
    
    csv {
      separator => ","
      columns => [
        "timestamp",
        "log_type",
        "level",
        "client_ip",
        "user_id",
        "method",
        "endpoint",
        "status_code",
        "response_time_ms",
        "user_agent",
        "message",
        "sql_query",
        "query_duration_ms",
        "server",
        "tenant_id"
      ]
      skip_empty_columns => true
    }
    
    # Parse timestamp
    date {
      match => ["timestamp", "ISO8601", "yyyy-MM-dd HH:mm:ss", "yyyy-MM-dd'T'HH:mm:ss'Z'"]
      target => "@timestamp"
    }
    
    # Convert numeric fields
    mutate {
      convert => {
        "status_code" => "integer"
        "response_time_ms" => "float"
        "query_duration_ms" => "float"
      }
    }
    
    # Add GeoIP for client IP
    if [client_ip] {
      geoip {
        source => "client_ip"
        target => "geoip"
      }
    }
    
    # Remove the raw message field
    mutate {
      remove_field => ["message", "host", "path"]
    }
  }
  
  if [type] == "json" {
    # Parse timestamp if exists
    if [timestamp] {
      date {
        match => ["timestamp", "ISO8601", "yyyy-MM-dd HH:mm:ss", "yyyy-MM-dd'T'HH:mm:ss'Z'"]
        target => "@timestamp"
      }
    }
    
    # Convert numeric fields if they exist
    if [status_code] {
      mutate {
        convert => { "status_code" => "integer" }
      }
    }
    
    if [response_time_ms] {
      mutate {
        convert => { "response_time_ms" => "float" }
      }
    }
    
    if [query_duration_ms] {
      mutate {
        convert => { "query_duration_ms" => "float" }
      }
    }
    
    # Add GeoIP for client IP
    if [client_ip] {
      geoip {
        source => "client_ip"
        target => "geoip"
      }
    }
  }
  
  # Add common fields
  mutate {
    add_field => {
      "[@metadata][index_prefix]" => "saas-logs"
      "data_source" => "%{type}"
    }
  }
}

output {
  elasticsearch {
    hosts => ["http://elasticsearch:9200"]
    index => "saas-logs-%{+YYYY.MM.dd}"
    document_type => "_doc"
  }
  
  # Uncomment for debugging
  # stdout {
  #   codec => rubydebug
  # }
}
